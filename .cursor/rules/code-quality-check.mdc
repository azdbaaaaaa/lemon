# 代码质量检查规则

## 规则说明

在完成任何代码改动后，**必须**运行构建和测试命令，确保代码质量符合要求。

## 检查时机

以下情况**必须**运行代码质量检查：

1. ✅ **新增或修改了任何 Go 代码文件**
2. ✅ **修改了依赖关系**（`go.mod`、`go.sum`）
3. ✅ **重构了代码结构**（文件移动、重命名）
4. ✅ **修改了接口定义**（Handler、Service、Repository 方法签名）
5. ✅ **完成了某个功能模块的实现**

## 检查步骤

### 1. 运行 Lint 检查

**命令**:
```bash
make lint
```

**目的**:
- 检查代码风格是否符合规范
- 发现潜在的代码问题
- 确保代码符合 Go 最佳实践

**要求**:
- ✅ Lint 检查必须通过，无错误
- ✅ 如果有警告，需要评估是否需要修复
- ❌ 不允许在有 Lint 错误的情况下提交代码

### 2. 运行测试

**命令**:
```bash
make test
```

**目的**:
- 运行所有单元测试
- 确保现有功能未被破坏
- 验证新功能的正确性

**要求**:
- ✅ 所有测试必须通过
- ✅ 测试覆盖率不应降低
- ❌ 不允许在有测试失败的情况下提交代码

### 3. 运行构建

**命令**:
```bash
make build
```

**目的**:
- 验证代码能够成功编译
- 检查是否有编译错误
- 确保依赖关系正确

**要求**:
- ✅ 构建必须成功，无编译错误
- ✅ 生成的可执行文件应该能够正常启动
- ❌ 不允许在有编译错误的情况下提交代码

## 完整检查流程

### 推荐流程

在完成代码改动后，按以下顺序执行：

```bash
# 1. 先运行 Lint 检查
make lint

# 2. 如果 Lint 通过，运行测试
make test

# 3. 如果测试通过，运行构建
make build
```

### 快速检查（开发阶段）

如果只是小的改动，可以运行：

```bash
# 运行所有检查（lint + test + build）
make all
```

**注意**: `make all` 会依次运行 `lint`、`test`、`build`，这是最完整的检查。

## 自动化检查

### 在代码改动后自动运行

**AI 助手应该**:
1. 在完成代码改动后，**主动**运行 `make all`（或依次运行 `make lint`、`make test`、`make build`）
2. 如果检查失败，**必须**修复问题后再继续
3. 将检查结果告知用户
4. 如果某个检查失败，应该先修复该问题，再继续后续检查

**示例工作流**:
```
1. 用户请求："实现用户注册功能"
2. AI 实现代码
3. AI 自动运行：make all
   - 如果失败，AI 分析错误并修复
   - 重新运行直到所有检查通过
4. 所有检查通过后，告知用户完成
```

**或者分步检查**:
```
1. 用户请求："实现用户注册功能"
2. AI 实现代码
3. AI 自动运行：make lint
   - 如果有错误，AI 修复并重新运行
4. AI 自动运行：make test
   - 如果有失败，AI 修复并重新运行
5. AI 自动运行：make build
   - 如果构建失败，AI 修复并重新运行
6. 所有检查通过后，告知用户完成
```

## 常见问题处理

### Lint 错误

**常见错误**:
- 未使用的导入
- 未使用的变量
- 代码格式问题
- 命名规范问题

**处理方法**:
1. 查看 Lint 错误信息
2. 根据错误提示修复代码
3. 重新运行 `make lint` 验证

### 测试失败

**常见原因**:
- 新代码破坏了现有功能
- 测试用例需要更新
- 依赖关系问题

**处理方法**:
1. 查看测试失败的具体信息
2. 分析失败原因
3. 修复代码或更新测试用例
4. 重新运行 `make test` 验证

### 构建失败

**常见原因**:
- 编译错误（语法错误、类型错误）
- 依赖缺失
- 导入路径错误

**处理方法**:
1. 查看编译错误信息
2. 修复语法或类型错误
3. 运行 `go mod tidy` 更新依赖
4. 重新运行 `make build` 验证

## 检查清单

在提交代码前，请确认：

- [ ] ✅ `make lint` 通过，无错误
- [ ] ✅ `make test` 通过，所有测试用例成功
- [ ] ✅ `make build` 通过，代码能够成功编译
- [ ] ✅ 如果有新的依赖，已运行 `go mod tidy`
- [ ] ✅ 代码符合分层架构要求（参考 `layer-architecture-check.mdc`）

## 集成到开发流程

### 开发阶段

在开发过程中，可以：
- 频繁运行 `make lint` 检查代码风格
- 编写代码时同步编写测试用例
- 定期运行 `make test` 确保功能正常

### 提交前

在提交代码前，**必须**：
1. 运行完整的检查流程（lint、test、build）
2. 确保所有检查通过
3. 修复所有发现的问题

### CI/CD 集成

这些检查也应该集成到 CI/CD 流程中：
- 每次 Pull Request 都应该运行这些检查
- 只有所有检查通过才能合并代码

## 注意事项

1. **不要跳过检查**: 即使是很小的改动，也应该运行检查
2. **及时修复**: 发现的问题应该立即修复，不要累积
3. **保持测试更新**: 新功能应该添加相应的测试用例
4. **关注性能**: 构建时间过长可能表示代码结构有问题

## 相关文档

- [分层架构检查规则](./layer-architecture-check.mdc) - 代码架构规范
- [开发规范文档](../../docs/guide/DEVELOPMENT_RULES.md) - 开发流程规范
- [Makefile](../../Makefile) - 构建命令定义
